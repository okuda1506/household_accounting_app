# アーキテクチャ設計ドキュメント

<br> 

## パスワード変更ルール
本システムのログイン済みユーザー向け **パスワード変更機能**では、
セキュリティ要件とユーザー体験（UX）の両立を目的として、以下の設計方針を採用する。

---

### 1. 入力項目

| 項目名                         | 必須 | 説明            |
| --------------------------- | -- | ------------- |
| `current_password`          | ○  | 現在のパスワード      |
| `new_password`              | ○  | 新しいパスワード      |
| `new_password_confirmation` | ○  | 新しいパスワード（確認用） |

---

### 2. バリデーション設計

#### current_password

* 必須入力
* 入力値の正当性（現在のパスワードと一致するか）は **Service 層**で検証する
* 不一致の場合は **業務例外（DomainException）**として扱う

```php
'current_password' => ['required'],
```

---

#### new_password

* 必須入力
* 確認用項目と一致すること
* パスワード強度ルールを満たすこと
* `bail` を指定し、致命的なエラーは最初の 1 件で打ち切る

```php
'new_password' => [
    'bail',
    'required',
    'confirmed',
    Password::defaults(),
],
```

---

### 3. パスワード強度ルール（共通デフォルト）

パスワードの強度要件は `Password::defaults()` により共通定義されている。

#### 要件

* 8 文字以上
* 255 文字以下
* 大文字と小文字のアルファベットをそれぞれ 1 文字以上含む
* 数字を 1 文字以上含む

```php
Password::min(8)
    ->max(255)
    ->mixedCase()
    ->numbers();
```

---

### 4. エラーメッセージ設計方針

#### new_password のエラー

* **複数のエラーメッセージを同時に返却する**
* パスワードは複数条件の集合体であるため、不足している条件を一度にユーザーへ提示する

**例**

```json
[
  "新しいパスワードは8文字以上で入力してください。",
  "新しいパスワードは少なくとも大文字と小文字を1つずつ含める必要があります。",
  "新しいパスワードは少なくとも1つの数字が含まれていなければなりません。"
]
```

---

#### current_password のエラー

* **単一のエラーメッセージのみ返却**
* 原因が 1 つに特定できるため、複数表示は行わない

---

### 5. 例外処理方針

* 現在のパスワード不一致は **業務例外**として扱う
* `InvalidCurrentPasswordException` を投げ、Controller 側で明示的に catch する
* HTTP ステータスコードは `422 Unprocessable Entity` を返却する

---

### 6. 設計方針まとめ

* 入力不足や整合性エラーは **1 件で打ち切る（bail）**
* セキュリティポリシー違反は **まとめてユーザーに通知**
* 業務ロジック由来のエラーは **DomainException により分離**
* API レスポンス形式は `messages: string[]` に統一し、拡張性を確保する

---

### 7. 期待される効果

* ユーザーは一度の入力で修正すべき内容を把握できる
* パスワードポリシー変更時も API・フロント双方の修正コストが低い
* セキュリティ要件と UX を両立した実装が可能となる

---

<br>

## パスワードリセット・アカウント再開時のルール
「パスワードをお忘れの方」および「アカウント再開」機能におけるパスワード設定処理では、
Laravel標準のパスワードリセット機能（Password Broker）に準拠しつつ、共通のパスワードポリシーを適用する。

---

### 1. 入力項目

| 項目名                     | 必須 | 説明                |
| ----------------------- | -- | ----------------- |
| `token`                 | ○  | リセット用トークン（Hidden） |
| `email`                 | ○  | メールアドレス（Hidden）    |
| `password`              | ○  | 新しいパスワード          |
| `password_confirmation` | ○  | 新しいパスワード（確認用）     |

---

### 2. バリデーション設計

#### token / email

* 必須入力
* トークンの有効性検証は **Laravel標準機能（Password::reset）** 内部で実施される
* 不正なトークンの場合、更新処理は実行されずエラーとなる

#### password

* 必須入力
* 確認用項目と一致すること
* **共通のパスワード強度ルール**を満たすこと

```php
'password' => [
    'required',
    'confirmed',
    Password::defaults(),
],
```

---

### 3. エラーハンドリング方針

#### トークン検証エラー

* トークン不一致、期限切れ、メールアドレス不一致の場合は、セキュリティリスクを考慮しつつ適切なエラーメッセージを返却する
* 実装上は `Password::reset` の戻り値（status）に基づき判定する

#### パスワード強度エラー

* ログイン済みユーザーの変更機能と同様、**複数のエラーメッセージを同時に返却**する方針とする

---

### 4. 設計方針まとめ

* トークン検証ロジックはフレームワーク標準機能に委譲し、セキュリティを担保する
* パスワード強度はシステム全体で統一されたルール（`Password::defaults()`）を適用する

---
